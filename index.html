<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room Real-time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        
        .container {
            width: 90%;
            max-width: 500px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .form-container {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .chat-container {
            display: none;
            flex-direction: column;
            height: 500px;
        }
        
        .chat-header {
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fdbb2d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .logout-btn {
            background: none;
            border: 1px solid white;
            width: auto;
            padding: 8px 15px;
        }
        
        .messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .received {
            background-color: #e9ecef;
        }
        
        .sent {
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            margin-left: auto;
        }
        
        .message-info {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        
        .message-input {
            flex: 1;
            margin-right: 10px;
        }
        
        .encrypted {
            font-family: monospace;
            letter-spacing: 2px;
            cursor: pointer;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #666;
            padding: 5px 15px;
            font-size: 0.9rem;
            min-height: 20px;
        }
        
        .online-users {
            padding: 10px 15px;
            background-color: #e9ecef;
            border-bottom: 1px solid #ddd;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chat Room Real-time</h1>
            <p>Kết nối và trò chuyện với mọi người</p>
        </div>
        
        <div class="form-container" id="loginForm">
            <div class="form-group">
                <label for="username">Tên của bạn</label>
                <input type="text" id="username" placeholder="Nhập tên hiển thị">
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu phòng</label>
                <input type="password" id="password" placeholder="Mật khẩu: zxc">
            </div>
            <button id="loginBtn">Vào Phòng Chat</button>
            <p style="text-align: center; margin-top: 15px; color: #666;">
                Mật khẩu mặc định: <strong>zxc</strong>
            </p>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userDisplayName">Người dùng</div>
                        <div style="font-size: 0.8rem;">Đang trực tuyến</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">Thoát</button>
            </div>
            
            <div class="online-users" id="onlineUsers">
                Đang tải...
            </div>
            
            <div class="messages" id="messagesContainer">
                <div class="message received">
                    <div>Chào mừng bạn đến với phòng chat!</div>
                    <div class="message-info">Hệ thống • Vừa xong</div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator"></div>
            
            <div class="input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="Nhập tin nhắn của bạn...">
                <button id="sendBtn">Gửi</button>
            </div>
        </div>
    </div>

    <script>
        // Các phần tử DOM
        const loginForm = document.getElementById('loginForm');
        const chatContainer = document.getElementById('chatContainer');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const userDisplayName = document.getElementById('userDisplayName');
        const userAvatar = document.getElementById('userAvatar');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const onlineUsers = document.getElementById('onlineUsers');

        // Biến toàn cục
        let currentUser = null;
        let messages = [];
        let users = [];
        let typingUsers = {};
        let typingTimeout = null;

        // Mật khẩu mặc định
        const defaultPassword = 'zxc';

        // Hàm mã hóa tin nhắn
        function encryptMessage(message) {
            let encrypted = '';
            const characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            
            for (let i = 0; i < message.length; i++) {
                const randomChar = characters.charAt(Math.floor(Math.random() * characters.length));
                encrypted += randomChar;
            }
            
            return encrypted;
        }

        // Hàm lưu tin nhắn vào localStorage
        function saveMessages() {
            localStorage.setItem('chatMessages', JSON.stringify(messages));
        }

        // Hàm tải tin nhắn từ localStorage
        function loadMessages() {
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
                renderMessages();
            }
        }

        // Hàm hiển thị tin nhắn
        function renderMessages() {
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
                
                const encryptedMessage = document.createElement('div');
                encryptedMessage.className = 'encrypted';
                encryptedMessage.textContent = msg.encrypted;
                encryptedMessage.setAttribute('data-original', msg.content);
                
                // Thêm sự kiện hover để hiển thị tin nhắn gốc
                encryptedMessage.addEventListener('mouseenter', function() {
                    this.textContent = this.getAttribute('data-original');
                });
                
                encryptedMessage.addEventListener('mouseleave', function() {
                    this.textContent = msg.encrypted;
                });
                
                const messageInfo = document.createElement('div');
                messageInfo.className = 'message-info';
                messageInfo.textContent = `${msg.sender} • ${msg.time}`;
                
                messageElement.appendChild(encryptedMessage);
                messageElement.appendChild(messageInfo);
                
                messagesContainer.appendChild(messageElement);
            });
            
            // Cuộn xuống dưới cùng
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hàm thêm tin nhắn mới
        function addMessage(content, sender, isEncrypted = true) {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            const encrypted = isEncrypted ? encryptMessage(content) : content;
            
            const message = {
                content,
                encrypted,
                sender,
                time: timeString,
                timestamp: now.getTime()
            };
            
            messages.push(message);
            renderMessages();
            saveMessages();
        }

        // Hàm cập nhật danh sách người dùng online
        function updateOnlineUsers() {
            // Giả lập có 3-5 người dùng online ngẫu nhiên
            const sampleUsers = ['Minh', 'Lan', 'Hùng', 'An', 'Tú', 'Chi'];
            const onlineCount = Math.floor(Math.random() * 3) + 3; // 3-5 người
            const onlineList = [currentUser]; // Luôn có current user
            
            // Thêm người dùng ngẫu nhiên
            for (let i = 0; i < onlineCount; i++) {
                const randomUser = sampleUsers[Math.floor(Math.random() * sampleUsers.length)];
                if (!onlineList.includes(randomUser)) {
                    onlineList.push(randomUser);
                }
            }
            
            users = onlineList;
            onlineUsers.textContent = `Đang online: ${users.join(', ')}`;
        }

        // Hàm cập nhật trạng thái đang nhập
        function updateTypingIndicator() {
            const typingUsersList = Object.keys(typingUsers).filter(user => 
                user !== currentUser && typingUsers[user] > Date.now() - 2000
            );
            
            if (typingUsersList.length > 0) {
                if (typingUsersList.length === 1) {
                    typingIndicator.textContent = `${typingUsersList[0]} đang soạn tin...`;
                } else {
                    typingIndicator.textContent = `${typingUsersList.join(', ')} đang soạn tin...`;
                }
            } else {
                typingIndicator.textContent = '';
            }
        }

        // Hàm giả lập người dùng khác đang nhập
        function simulateOtherUserTyping() {
            if (users.length > 1 && Math.random() < 0.3) {
                const otherUsers = users.filter(user => user !== currentUser);
                if (otherUsers.length > 0) {
                    const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
                    typingUsers[randomUser] = Date.now();
                    updateTypingIndicator();
                    
                    // Tự động xóa sau 2 giây
                    setTimeout(() => {
                        updateTypingIndicator();
                    }, 2000);
                }
            }
        }

        // Hàm giả lập nhận tin nhắn từ người dùng khác
        function simulateOtherUserMessage() {
            if (users.length > 1 && Math.random() < 0.4) {
                const otherUsers = users.filter(user => user !== currentUser);
                if (otherUsers.length > 0) {
                    const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
                    const sampleMessages = [
                        "Xin chào mọi người!",
                        "Có ai ở đây không?",
                        "Tin nhắn này đã được mã hóa!",
                        "Di chuột vào tin nhắn để xem nội dung thật",
                        "Ứng dụng chat này thú vị nhỉ!",
                        "Hôm nay mọi người thế nào?",
                        "Tôi vừa tham gia phòng chat này"
                    ];
                    
                    const randomMessage = sampleMessages[Math.floor(Math.random() * sampleMessages.length)];
                    addMessage(randomMessage, randomUser);
                }
            }
        }

        // Xử lý đăng nhập
        loginBtn.addEventListener('click', function() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (username === '' || password === '') {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }
            
            if (password !== defaultPassword) {
                alert('Mật khẩu không chính xác!');
                return;
            }
            
            currentUser = username;
            
            // Ẩn form đăng nhập, hiện giao diện chat
            loginForm.style.display = 'none';
            chatContainer.style.display = 'flex';
            
            // Hiển thị thông tin người dùng
            userDisplayName.textContent = username;
            userAvatar.textContent = username.charAt(0).toUpperCase();
            
            // Tải tin nhắn
            loadMessages();
            
            // Cập nhật danh sách người dùng
            updateOnlineUsers();
            
            // Thêm tin nhắn chào mừng
            addMessage(`Chào mừng ${username} đã tham gia phòng chat!`, "Hệ thống", false);
            
            // Bắt đầu mô phỏng hoạt động của người dùng khác
            setInterval(updateOnlineUsers, 10000); // Cập nhật mỗi 10s
            setInterval(simulateOtherUserTyping, 5000); // Mô phỏng typing mỗi 5s
            setInterval(simulateOtherUserMessage, 8000); // Mô phỏng tin nhắn mỗi 8s
        });

        // Xử lý đăng xuất
        logoutBtn.addEventListener('click', function() {
            chatContainer.style.display = 'none';
            loginForm.style.display = 'block';
            usernameInput.value = '';
            passwordInput.value = '';
            
            // Thêm thông báo người dùng rời khỏi
            addMessage(`${currentUser} đã rời khỏi phòng chat.`, "Hệ thống", false);
            
            currentUser = null;
        });

        // Hàm gửi tin nhắn
        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (message === '') {
                return;
            }
            
            addMessage(message, currentUser);
            
            // Xóa nội dung ô nhập
            messageInput.value = '';
            
            // Xóa trạng thái đang nhập
            delete typingUsers[currentUser];
            updateTypingIndicator();
        }

        // Xử lý sự kiện gửi tin nhắn
        sendBtn.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Xử lý sự kiện nhập tin nhắn (hiển thị "đang nhập...")
        messageInput.addEventListener('input', function() {
            // Cập nhật trạng thái đang nhập
            typingUsers[currentUser] = Date.now();
            updateTypingIndicator();
            
            // Xóa timeout cũ
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // Đặt timeout mới để xóa trạng thái sau 2 giây không nhập
            typingTimeout = setTimeout(() => {
                delete typingUsers[currentUser];
                updateTypingIndicator();
            }, 2000);
        });

        // Tải tin nhắn mẫu khi trang được tải
        window.addEventListener('load', function() {
            // Thêm một số tin nhắn mẫu để demo
            setTimeout(() => {
                if (messages.length === 0) {
                    addMessage("Chào mừng đến với phòng chat real-time!", "Hệ thống", false);
                    addMessage("Tin nhắn sẽ được lưu lại và không bị mất khi refresh trang.", "Hệ thống", false);
                    addMessage("Mọi người có thể cùng tham gia trò chuyện!", "Hệ thống", false);
                }
            }, 500);
        });
    </script>
</body>
</html>
